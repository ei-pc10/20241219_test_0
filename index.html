<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>AR.js Location-Based 3D Models</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.0.0/dist/aframe-extras.min.js"></script>
    <script type='text/javascript' src='https://raw.githack.com/AR-js-org/AR.js/master/three.js/build/ar-threex-location-only.js'></script>
  </head>
  <body style="margin: 0; overflow: hidden;">
    <a-scene
      gps-camera
      embedded
      arjs
      vr-mode-ui="enabled: false"
      renderer="logarithmicDepthBuffer: true;">

      <a-camera gps-camera rotation-reader></a-camera>

      <script>
        // Load data.json
        fetch('data.json')
          .then(response => response.json())
          .then(data => {
            navigator.geolocation.watchPosition((position) => {
              const userLatitude = position.coords.latitude;
              const userLongitude = position.coords.longitude;

              data.forEach(location => {
                const distance = calculateDistance(
                  userLatitude, userLongitude,
                  location.latitude, location.longitude
                );

                updateDistanceDisplay(location.name, distance);

                if (distance <= 2000) {
                  const scaleIndex = Math.min(Math.floor(distance / 100), scaleArray.length - 1);
                  const modelScale = scaleArray[scaleIndex];
                  const modelPosition = positionArray[scaleIndex];

                  createModel(location, modelScale, modelPosition);
                }
              });
            });
          });

        const scaleArray = [0.3, 0.35, 0.40, 0.70, 1.3, 2.0, 3.5, 5.0, 6.5, 7.5, 8.5, 9.0, 9.5, 10.0, 10.5, 11.1, 30, 60, 70, 100];
        const positionArray = [5, 10, 12, 17, 20, 23, 30, 35, 40, 75, 90, 150, 170, 200, 240, 270, 320, 350, 400, 500];

        function calculateDistance(lat1, lon1, lat2, lon2) {
          const R = 6371e3; // Earth radius in meters
          const phi1 = lat1 * (Math.PI / 180);
          const phi2 = lat2 * (Math.PI / 180);
          const deltaPhi = (lat2 - lat1) * (Math.PI / 180);
          const deltaLambda = (lon2 - lon1) * (Math.PI / 180);

          const a = Math.sin(deltaPhi / 2) * Math.sin(deltaPhi / 2) +
                    Math.cos(phi1) * Math.cos(phi2) *
                    Math.sin(deltaLambda / 2) * Math.sin(deltaLambda / 2);
          const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

          return R * c;
        }

        function updateDistanceDisplay(name, distance) {
          const distanceElement = document.getElementById('distance-display') || createDistanceDisplay();
          distanceElement.innerHTML += <p>${name}: ${Math.round(distance)}m</p>;
        }

        function createDistanceDisplay() {
          const div = document.createElement('div');
          div.id = 'distance-display';
          div.style.position = 'absolute';
          div.style.top = '10px';
          div.style.right = '10px';
          div.style.backgroundColor = 'rgba(255, 255, 255, 0.8)';
          div.style.padding = '10px';
          div.style.borderRadius = '5px';
          div.style.zIndex = '100';
          document.body.appendChild(div);
          return div;
        }

        function createModel(location, scale, position) {
          const scene = document.querySelector('a-scene');

          const entity = document.createElement('a-entity');
          entity.setAttribute('gps-entity-place', latitude: ${location.latitude}; longitude: ${location.longitude});
          entity.setAttribute('gltf-model', location.modelUrl);
          entity.setAttribute('scale', ${scale} ${scale} ${scale});
          entity.setAttribute('position', 0 0 -${position});
          entity.setAttribute('look-at', '[gps-camera]');

          scene.appendChild(entity);
        }
      </script>
    </a-scene>
  </body>
</html>
